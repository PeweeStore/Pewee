extends layout

mixin versionTile(appName, version, oss)
  a(href=('/app/'+appName+'/'+version+'/detail')) #{version} #{oss}

mixin iOSDownloadButton(appName, version, enabled)
  if enabled
    a.btn-info.btn-block.ios-download-button(id='ios-download-button-'+version, href="#")
      span.glyphicon.glyphicon-download.pull-left
      span.download-text Download
    script(type="text/javascript").
      function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i=0; i<ca.length; i++) {
          var c = ca[i].trim();
          if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
        }
        return "";
      }
      var href = 'itms-services://?action=download-manifest&url=https://' + location.hostname + (location.port? (':' + location.port): "") + '/app/#{appName}/#{version}/download/ios/' + getCookie("#{appName}");
      $("a[id='ios-download-button-#{version}']").attr('href', href);

  else
    a.btn.btn-info.btn-block.disabled.ios-download-button
      span.glyphicon.glyphicon-download.pull-left
      span.download-text Download


mixin androidDownloadButton(appName, version, enabled)
  if enabled
    a.btn.btn-success.btn-block.android-download-button(href='/app/'+appName+'/'+version+'/download/android')
      span.glyphicon.glyphicon-download.pull-left
      span.download-text Download
  else
    a.btn.btn-success.btn-block.disabled.android-download-button
      span.glyphicon.glyphicon-download.pull-left
      span.download-text Download


mixin versionLine(appName, version, os)
  .row
    .col-xs-6
      h3= version
    .col-xs-3
      +iOSDownloadButton(appName, version, os.contains('ios'))
    .col-xs-3
      +androidDownloadButton(appName, version, os.contains('android'))


block content

  #app-detail-jumbotron.jumbotron
    img#app-detail-image.pull-right
    h1 #{app}
  .container-fluid
    .row
      .col-xs-6
        h4#app-detail-app-list-version-header Version
      .col-xs-3
        h3#app-detail-app-list-ios-header
          img(src='/img/apple.png')
          span iOS
      .col-xs-3
        h3#app-detail-app-list-android-header
          img(src='/img/android.png')
          span Android
    each os, version in versions
      +versionLine(app, version, os)


  script(type='text/javascript').
    var app = '#{app}';
    $.getJSON('/app/'+app+'/detail', function(data) {
      if(data.image) {
        $('#app-detail-image').attr('src', 'data:image/png;base64,'+data.image);
      }
    });
